<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Estimation SPOTICAR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }

        body {
            font-family: Arial, sans-serif;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .site-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://usine-a-sites.s3.eu-west-1.amazonaws.com/site-peugeot-test/Capture+d%E2%80%99e%CC%81cran+2025-09-30+a%CC%80+23.33.49.png') no-repeat center center;
            background-size: cover;
            overflow: hidden;
        }

        .site-header {
            display: none;
        }

        .site-logo {
            display: none;
        }

        .site-nav {
            display: none;
        }

        .site-hero {
            display: none;
        }

        .site-cars {
            display: none;
        }

        .car-card {
            display: none;
        }

        .car-image {
            display: none;
        }

        .car-info {
            display: none;
        }

        .car-name {
            display: none;
        }

        .car-details {
            display: none;
        }

        .car-price {
            display: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow: hidden;
            z-index: 1000;
        }

        .widget-container {
            width: 100%;
            max-width: 480px;
            height: auto;
            max-height: calc(100% - 2rem);
            background: #ffffff;
            border-radius: 16px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .widget-container {
                max-width: 680px;
            }

            .widget-header {
                padding: 1.5rem 2rem 0.75rem;
            }

            .logo {
                width: 160px;
                height: 50px;
            }

            .main-title {
                font-size: 1.6rem;
            }

            .subtitle {
                font-size: 0.95rem;
            }

            .widget-content {
                padding: 0 2rem 1.5rem;
            }

            .form-input {
                padding: 0.875rem;
                font-size: 0.95rem;
            }

            .cta-button {
                padding: 1rem;
                font-size: 1rem;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close-btn, .back-button {
            position: absolute;
            top: 1rem;
            width: 32px;
            height: 32px;
            border: none;
            background: #f1f5f9;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            transition: all 0.2s ease;
            z-index: 10;
            font-size: 1.25rem;
        }

        .close-btn {
            right: 1rem;
            font-size: 1.5rem;
        }

        .back-button {
            left: 1rem;
            display: none;
        }

        .back-button.visible {
            display: flex;
        }

        .close-btn:hover, .back-button:hover {
            background: #e2e8f0;
        }

        .widget-header {
            padding: 1rem 1rem 0.5rem;
            text-align: center;
            flex-shrink: 0;
        }

        .logo {
            width: 140px;
            height: 45px;
            margin: 0 auto 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo img {
            width: 100%;
            height: auto;
            object-fit: contain;
        }

        .main-title {
            font-size: 1.35rem;
            font-weight: bold;
            color: #000;
            margin-bottom: 0.35rem;
        }

        .main-title.hidden {
            display: none !important;
        }

        .subtitle {
            font-size: 0.875rem;
            color: #666;
            line-height: 1.4;
        }

        .subtitle.hidden {
            display: none !important;
        }

        #progress-container {
            flex-shrink: 0;
        }

        .progress-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0.5rem 1rem 0.75rem;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #13d0ca;
            transition: width 0.3s ease;
        }

        .step-indicator {
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
            font-weight: 500;
        }

        .widget-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 1rem 1rem;
            -webkit-overflow-scrolling: touch;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 100;
            gap: 1rem;
        }

        .loader-overlay.active {
            display: flex;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #13d0ca;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .loader-text {
            font-size: 0.95rem;
            color: #666;
            font-weight: 500;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            color: #000;
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #000;
            font-family: Arial, sans-serif;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #13d0ca;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        .form-input.error {
            border-color: #ef4444;
        }

        .form-input::placeholder {
            color: #999;
        }

        .vehicle-recap {
            text-align: center;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 1rem;
        }

        #step-2 .vehicle-recap {
            font-size: 0.95rem;
            color: #000;
            margin-bottom: 1.25rem;
            font-weight: 600;
            background: #f0fffe;
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #13d0ca;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        #step-2 .vehicle-recap::before {
            content: 'Véhicule trouvé : ';
            color: #13d0ca;
            font-weight: 700;
        }

        .reassurance-box {
            background: #f0fffe;
            border-left: 3px solid #13d0ca;
            padding: 0.875rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .reassurance-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .reassurance-title span {
            font-size: 1.1rem;
        }

        .reassurance-title strong {
            font-size: 0.875rem;
            color: #000;
        }

        .reassurance-text {
            font-size: 0.75rem;
            color: #555;
            line-height: 1.4;
        }

        .finition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.625rem;
            margin-bottom: 1rem;
        }

        .finition-card {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-size: 0.875rem;
            color: #000;
            font-weight: 500;
        }

        .finition-card:hover {
            border-color: #13d0ca;
            background: #f0fffe;
        }

        .finition-card.selected {
            border-color: #13d0ca;
            background: #13d0ca;
            color: white;
        }

        .checkbox-group {
            margin-bottom: 1rem;
        }

        .checkbox-group h3 {
            font-size: 0.875rem;
            font-weight: bold;
            color: #000;
            margin-bottom: 0.75rem;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.875rem;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin-top: 0.2rem;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            cursor: pointer;
            accent-color: #13d0ca;
        }

        .checkbox-wrapper label {
            font-size: 0.75rem;
            color: #333;
            line-height: 1.4;
            cursor: pointer;
        }

        .checkbox-wrapper label a {
            color: #13d0ca;
            text-decoration: underline;
        }

        .consent-section-title {
            font-weight: bold;
            font-size: 0.8rem;
            color: #000;
            margin: 1rem 0 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .consent-section-title::after {
            content: '▲';
            font-size: 0.65rem;
            color: #13d0ca;
        }

        .consent-section-title.collapsed::after {
            content: '▼';
        }

        .consent-details {
            font-size: 0.75rem;
            color: #555;
            line-height: 1.5;
            margin-bottom: 0.75rem;
            padding-left: 1rem;
        }

        .consent-details.hidden {
            display: none;
        }

        .result-price {
            text-align: center;
            margin: 0.5rem 0 0.875rem;
        }

        .price-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.4rem;
        }

        .price-amount {
            font-size: 2rem;
            font-weight: bold;
            color: #13d0ca;
        }

        .info-box {
            background: #f8f8f8;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.875rem 0;
            font-size: 0.7rem;
            line-height: 1.4;
            color: #333;
        }

        .info-box strong {
            color: #000;
            display: block;
            margin-bottom: 0.3rem;
            font-size: 0.75rem;
        }

        .next-steps-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #000;
            margin-bottom: 0.625rem;
            text-align: center;
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.625rem;
            margin-bottom: 0.75rem;
        }

        .step-card {
            background: #f8f8f8;
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 3px solid #13d0ca;
        }

        .step-card-title {
            font-weight: bold;
            color: #000;
            margin-bottom: 0.3rem;
            font-size: 0.75rem;
        }

        .step-card-text {
            font-size: 0.7rem;
            color: #555;
            line-height: 1.3;
        }

        .cta-button {
            width: 100%;
            padding: 0.875rem;
            background: #13d0ca;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: Arial, sans-serif;
            margin-top: 0.75rem;
        }

        .cta-button:hover {
            background: #0fb8b3;
        }

        .cta-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-overlay {
                padding: 0.5rem;
            }

            .widget-container {
                max-height: calc(100% - 1rem);
            }

            .steps-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-height: 700px) {
            .logo {
                width: 120px;
                height: 40px;
            }

            .main-title {
                font-size: 1.2rem;
            }

            .subtitle {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="site-background"></div>

    <div class="modal-overlay">
        <div class="widget-container">
            <button class="back-button" onclick="goBack()" aria-label="Retour">←</button>
            <button class="close-btn" onclick="closeWidget()" aria-label="Fermer">×</button>
            
            <div class="loader-overlay" id="loader">
                <div class="loader"></div>
                <div class="loader-text">Recherche des finitions disponibles...</div>
            </div>
            
            <div class="widget-header">
                <div class="logo">
                    <img src="https://www.spoticar.lu/sites/spoticar.be/files/inline-images/2019-01-07-Logo-Spoticar.png" alt="SPOTICAR">
                </div>
                <h1 class="main-title">Informations sur votre véhicule</h1>
                <p class="subtitle" id="subtitle">Nous vous fournissons une estimation de votre voiture, basée sur son immatriculation, sa version et son kilométrage.</p>
            </div>

            <div id="progress-container">
                <div class="progress-wrapper">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 25%"></div>
                    </div>
                    <div class="step-indicator">
                        <span id="step-text">Étape 1/4</span>
                    </div>
                </div>
            </div>

            <div class="widget-content">
                <div class="step active" id="step-1">
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Immatriculation</label>
                            <input type="text" class="form-input" id="immatriculation" placeholder="Ex. AB-123-CD" maxlength="10">
                            <div class="error-message" id="error-immat">Format invalide (ex: AA-123-CD)</div>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="goToManualEntry()" style="background: none; border: none; color: #13d0ca; text-decoration: underline; cursor: pointer; font-size: 0.8rem; font-family: Arial, sans-serif; padding: 0;">
                                    Je ne connais pas mon immatriculation
                                </button>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Kilométrage</label>
                            <input type="number" class="form-input" id="kilometrage" placeholder="Ex: 75000" min="0">
                            <div class="error-message" id="error-km">Le kilométrage est requis</div>
                        </div>
                    </div>
                    
                    <div class="reassurance-box">
                        <div class="reassurance-title">
                            <span>✓</span>
                            <strong>Estimation gratuite et instantanée</strong>
                        </div>
                        <p class="reassurance-text">
                            Obtenez une estimation précise de votre véhicule en quelques clics, sans engagement et en toute confidentialité.
                        </p>
                    </div>
                    
                    <button class="cta-button" onclick="goToStep(2)" id="btn-step1" disabled>Confirmer le véhicule</button>
                </div>

                <div class="step" id="step-1b">
                    <h2 class="form-label" style="margin-bottom: 1rem; text-align: center;">Renseignez les informations de votre véhicule</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Marque</label>
                        <select class="form-input" id="marque">
                            <option value="">Sélectionnez une marque</option>
                            <option value="Peugeot">Peugeot</option>
                            <option value="Citroën">Citroën</option>
                            <option value="DS">DS</option>
                            <option value="Opel">Opel</option>
                            <option value="Renault">Renault</option>
                            <option value="Volkswagen">Volkswagen</option>
                            <option value="Toyota">Toyota</option>
                            <option value="BMW">BMW</option>
                            <option value="Mercedes">Mercedes</option>
                            <option value="Audi">Audi</option>
                            <option value="Ford">Ford</option>
                            <option value="Nissan">Nissan</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Modèle</label>
                        <select class="form-input" id="modele">
                            <option value="">Sélectionnez un modèle</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Mois</label>
                            <select class="form-input" id="mois">
                                <option value="">Mois</option>
                                <option value="01">Janvier</option>
                                <option value="02">Février</option>
                                <option value="03">Mars</option>
                                <option value="04">Avril</option>
                                <option value="05">Mai</option>
                                <option value="06">Juin</option>
                                <option value="07">Juillet</option>
                                <option value="08">Août</option>
                                <option value="09">Septembre</option>
                                <option value="10">Octobre</option>
                                <option value="11">Novembre</option>
                                <option value="12">Décembre</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Année</label>
                            <select class="form-input" id="annee">
                                <option value="">Année</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Énergie</label>
                        <select class="form-input" id="energie">
                            <option value="">Sélectionnez une énergie</option>
                            <option value="Essence">Essence</option>
                            <option value="Diesel">Diesel</option>
                            <option value="Hybride">Hybride</option>
                            <option value="Hybride rechargeable">Hybride rechargeable</option>
                            <option value="Électrique">Électrique</option>
                            <option value="GPL">GPL</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Version</label>
                        <select class="form-input" id="version">
                            <option value="">Sélectionnez une version</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Kilométrage</label>
                        <select class="form-input" id="kilometrage-manual">
                            <option value="">Sélectionnez un kilométrage</option>
                            <option value="5000">Moins de 10 000 km</option>
                            <option value="15000">10 000 - 20 000 km</option>
                            <option value="25000">20 000 - 30 000 km</option>
                            <option value="35000">30 000 - 40 000 km</option>
                            <option value="45000">40 000 - 50 000 km</option>
                            <option value="60000">50 000 - 70 000 km</option>
                            <option value="80000">70 000 - 90 000 km</option>
                            <option value="100000">90 000 - 110 000 km</option>
                            <option value="125000">110 000 - 140 000 km</option>
                            <option value="160000">140 000 - 180 000 km</option>
                            <option value="200000">Plus de 180 000 km</option>
                        </select>
                    </div>

                    <button class="cta-button" onclick="goToStep(3)" id="btn-step1b" disabled>Continuer</button>
                </div>

                <div class="step" id="step-2">
                    <div class="vehicle-recap" id="recap-step2"></div>
                    
                    <h2 class="form-label" style="margin-bottom: 0.75rem;">Sélectionnez la finition</h2>
                    <div class="finition-grid">
                        <div class="finition-card" onclick="selectFinition('Active')">Active</div>
                        <div class="finition-card" onclick="selectFinition('Allure')">Allure</div>
                        <div class="finition-card" onclick="selectFinition('GT Line')">GT Line</div>
                        <div class="finition-card" onclick="selectFinition('GT')">GT</div>
                        <div class="finition-card" onclick="selectFinition('Style')">Style</div>
                        <div class="finition-card" onclick="selectFinition('Access')">Access</div>
                        <div class="finition-card" onclick="selectFinition('Allure Pack')">Allure Pack</div>
                        <div class="finition-card" onclick="selectFinition('GT Pack')">GT Pack</div>
                    </div>
                    <button class="cta-button" onclick="goToStep(3)" id="btn-step2" disabled>Suivant</button>
                </div>

                <div class="step" id="step-3">
                    <div class="vehicle-recap" id="recap-step3"></div>
                    
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Nom</label>
                            <input type="text" class="form-input" id="nom" placeholder="Votre nom">
                            <div class="error-message" id="error-nom">Lettres uniquement</div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Prénom</label>
                            <input type="text" class="form-input" id="prenom" placeholder="Votre prénom">
                            <div class="error-message" id="error-prenom">Lettres uniquement</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="email" placeholder="votre@email.com">
                            <div class="error-message" id="error-email">Format email invalide</div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Téléphone</label>
                            <input type="tel" class="form-input" id="telephone" placeholder="06 00 00 00 00" maxlength="14">
                            <div class="error-message" id="error-tel">Format invalide (ex: 06 00 00 00 00)</div>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <h3>Consentements</h3>
                        
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="consent1" required>
                            <label for="consent1">Vos données personnelles seront traitées par SVO - SPOTICAR, situé au 2-10 Boulevard de l'Europe, 78300 Poissy, en tant que responsable de traitement, tel que décrit dans la <a href="#" target="_blank">Politique de Confidentialité</a>, où vous trouverez plus d'informations sur vos droits liés à la confidentialité et les moyens de nous contacter.</label>
                        </div>

                        <div class="consent-section-title" onclick="toggleSection('rejoignez1')">
                            Rejoignez-nous !
                        </div>
                        <div class="consent-details" id="rejoignez1">
                            Nous aimerions entretenir un lien privilégié avec vous et vous seul(e), et personnaliser l'expérience que nous allons partager ! Recevez des offres et des affaires personnalisées, des promotions, des invitations à des événements et d'autres contenus intéressants sur nos marques.
                        </div>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="consent2">
                            <label for="consent2">Je suis d'accord</label>
                        </div>

                        <div class="consent-section-title" onclick="toggleSection('partenaires')">
                            Rejoignez nos partenaires !
                        </div>
                        <div class="consent-details" id="partenaires">
                            Nous formons une grande communauté et partageons des choses intéressantes ! Si vous souhaitez rencontrer nos fantastiques partenaires et leur permettre de vous contacter directement, inscrivez-vous !
                        </div>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="consent3">
                            <label for="consent3">Je suis d'accord</label>
                        </div>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="consent4">
                            <label for="consent4">Je ne suis pas d'accord</label>
                        </div>
                    </div>
                    
                    <button class="cta-button" onclick="goToStep(4)" id="btn-step3" disabled>Obtenir votre estimation</button>
                </div>

                <div class="step" id="step-4">
                    <div class="result-price">
                        <div class="price-label">Estimation de votre véhicule</div>
                        <div class="price-amount" id="estimated-price">12 500 €</div>
                    </div>

                    <div class="vehicle-recap" id="recap-step4"></div>

                    <div class="info-box">
                        <strong>Comment avons-nous calculé ce prix ?</strong>
                        Notre estimation repose sur les caractéristiques de votre véhicule et sur l'analyse des tendances du marché. Elle inclut une déduction forfaitaire pour les frais de remise en état, ajustable en fonction de l'état réel de votre voiture.
                    </div>

                    <h3 class="next-steps-title">Prochaines étapes</h3>
                    <div class="steps-grid">
                        <div class="step-card">
                            <div class="step-card-title">Prise en main</div>
                            <div class="step-card-text">Une prise en main par un professionnel qualifié</div>
                        </div>
                        <div class="step-card">
                            <div class="step-card-title">Vente simplifiée</div>
                            <div class="step-card-text">Aucune démarche administrative à votre charge</div>
                        </div>
                    </div>

                    <button class="cta-button" onclick="closeWidget()">Continuer votre estimation</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedFinition = null;
        let userData = {
            immatriculation: '',
            kilometrage: '',
            finition: '',
            marque: '',
            modele: '',
            mois: '',
            annee: '',
            energie: '',
            version: ''
        };

        // Générer les années (de l'année actuelle jusqu'à 1990)
        const anneeSelect = document.getElementById('annee');
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= 1990; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            anneeSelect.appendChild(option);
        }

        // Gestion des modèles selon la marque
        const modelesParMarque = {
            'Peugeot': ['208', '308', '2008', '3008', '5008', '508', 'Rifter', 'Partner', 'Expert'],
            'Citroën': ['C3', 'C4', 'C5', 'Berlingo', 'Jumpy', 'C3 Aircross', 'C5 Aircross'],
            'DS': ['DS 3', 'DS 4', 'DS 7', 'DS 9'],
            'Opel': ['Corsa', 'Astra', 'Mokka', 'Crossland', 'Grandland', 'Combo'],
            'Renault': ['Clio', 'Captur', 'Megane', 'Scenic', 'Kadjar', 'Arkana', 'Austral', 'Twingo'],
            'Volkswagen': ['Polo', 'Golf', 'Tiguan', 'T-Roc', 'Passat', 'Touran', 'ID.3', 'ID.4'],
            'Toyota': ['Yaris', 'Corolla', 'C-HR', 'RAV4', 'Aygo', 'Prius', 'Camry'],
            'BMW': ['Série 1', 'Série 2', 'Série 3', 'Série 4', 'Série 5', 'X1', 'X3', 'X5'],
            'Mercedes': ['Classe A', 'Classe B', 'Classe C', 'Classe E', 'GLA', 'GLC', 'GLE'],
            'Audi': ['A1', 'A3', 'A4', 'A5', 'A6', 'Q2', 'Q3', 'Q5', 'Q7'],
            'Ford': ['Fiesta', 'Focus', 'Puma', 'Kuga', 'Mustang', 'Transit'],
            'Nissan': ['Micra', 'Juke', 'Qashqai', 'X-Trail', 'Leaf'],
            'Autre': []
        };

        const versionsParEnergie = {
            'Essence': ['1.0 70ch', '1.2 PureTech 110ch', '1.2 PureTech 130ch', '1.5 TSI 150ch', '1.6 THP 165ch', '2.0 TFSI 190ch'],
            'Diesel': ['1.5 BlueHDi 100ch', '1.5 BlueHDi 130ch', '1.6 BlueHDi 120ch', '2.0 BlueHDi 150ch', '2.0 BlueHDi 180ch'],
            'Hybride': ['Hybrid 136ch', 'Hybrid 160ch', 'Hybrid 180ch', 'Hybrid 225ch'],
            'Hybride rechargeable': ['Hybrid 180ch', 'Hybrid 225ch', 'Hybrid4 300ch'],
            'Électrique': ['136ch', '156ch', '218ch'],
            'GPL': ['1.2 PureTech 110ch GPL']
        };

        document.getElementById('marque').addEventListener('change', function() {
            const marque = this.value;
            const modeleSelect = document.getElementById('modele');
            
            // Réinitialiser le select modèle
            modeleSelect.innerHTML = '<option value="">Sélectionnez un modèle</option>';
            
            if (marque && modelesParMarque[marque]) {
                modelesParMarque[marque].forEach(modele => {
                    const option = document.createElement('option');
                    option.value = modele;
                    option.textContent = modele;
                    modeleSelect.appendChild(option);
                });
            }
            
            checkStep1bCompletion();
        });

        document.getElementById('energie').addEventListener('change', function() {
            const energie = this.value;
            const versionSelect = document.getElementById('version');
            
            // Réinitialiser le select version
            versionSelect.innerHTML = '<option value="">Sélectionnez une version</option>';
            
            if (energie && versionsParEnergie[energie]) {
                versionsParEnergie[energie].forEach(version => {
                    const option = document.createElement('option');
                    option.value = version;
                    option.textContent = version;
                    versionSelect.appendChild(option);
                });
            }
            
            checkStep1bCompletion();
        });

        document.getElementById('immatriculation').addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            
            if (value.length > 0) {
                let formatted = '';
                if (value.length <= 2) {
                    formatted = value;
                } else if (value.length <= 5) {
                    formatted = value.slice(0, 2) + '-' + value.slice(2);
                } else {
                    formatted = value.slice(0, 2) + '-' + value.slice(2, 5) + '-' + value.slice(5, 7);
                }
                e.target.value = formatted;
            }
            
            hideError('immat');
            checkStep1Completion();
        });

        document.getElementById('kilometrage').addEventListener('input', function() {
            hideError('km');
            checkStep1Completion();
        });

        function checkStep1Completion() {
            const immat = document.getElementById('immatriculation').value.trim();
            const km = document.getElementById('kilometrage').value.trim();
            const btn = document.getElementById('btn-step1');
            
            const immatRegex = /^[A-Z]{2}-[0-9]{3}-[A-Z]{2}$/;
            
            if (immatRegex.test(immat) && km && parseInt(km) > 0) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        // Validation étape 1b (saisie manuelle)
        document.getElementById('modele').addEventListener('change', checkStep1bCompletion);
        document.getElementById('mois').addEventListener('change', checkStep1bCompletion);
        document.getElementById('annee').addEventListener('change', checkStep1bCompletion);
        document.getElementById('version').addEventListener('change', checkStep1bCompletion);
        document.getElementById('kilometrage-manual').addEventListener('change', checkStep1bCompletion);

        function checkStep1bCompletion() {
            const marque = document.getElementById('marque').value.trim();
            const modele = document.getElementById('modele').value.trim();
            const mois = document.getElementById('mois').value.trim();
            const annee = document.getElementById('annee').value.trim();
            const energie = document.getElementById('energie').value.trim();
            const version = document.getElementById('version').value.trim();
            const km = document.getElementById('kilometrage-manual').value.trim();
            const btn = document.getElementById('btn-step1b');
            
            if (marque && modele && mois && annee && energie && version && km) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        function goToManualEntry() {
            document.getElementById('step-1').classList.remove('active');
            document.getElementById('step-1b').classList.add('active');
            currentStep = '1b';
            
            const backButton = document.querySelector('.back-button');
            backButton?.classList.add('visible');
        }

        document.getElementById('telephone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            let formatted = '';
            
            for (let i = 0; i < value.length && i < 10; i++) {
                if (i > 0 && i % 2 === 0) {
                    formatted += ' ';
                }
                formatted += value[i];
            }
            
            e.target.value = formatted;
            hideError('tel');
        });

        document.getElementById('nom').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^a-zA-ZÀ-ÿ\s\-']/g, '');
            hideError('nom');
            checkStep3Completion();
        });

        document.getElementById('prenom').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^a-zA-ZÀ-ÿ\s\-']/g, '');
            hideError('prenom');
            checkStep3Completion();
        });

        document.getElementById('email').addEventListener('input', function() {
            hideError('email');
            checkStep3Completion();
        });

        document.getElementById('telephone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            let formatted = '';
            
            for (let i = 0; i < value.length && i < 10; i++) {
                if (i > 0 && i % 2 === 0) {
                    formatted += ' ';
                }
                formatted += value[i];
            }
            
            e.target.value = formatted;
            hideError('tel');
            checkStep3Completion();
        });

        document.getElementById('consent1').addEventListener('change', checkStep3Completion);

        function checkStep3Completion() {
            const nom = document.getElementById('nom').value.trim();
            const prenom = document.getElementById('prenom').value.trim();
            const email = document.getElementById('email').value.trim();
            const tel = document.getElementById('telephone').value.trim();
            const btn = document.getElementById('btn-step3');
            
            const nameRegex = /^[a-zA-ZÀ-ÿ\s\-']+$/;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const telRegex = /^[0-9]{2}\s[0-9]{2}\s[0-9]{2}\s[0-9]{2}\s[0-9]{2}$/;
            
            if (nameRegex.test(nom) && nameRegex.test(prenom) && 
                emailRegex.test(email) && telRegex.test(tel)) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        function showError(field) {
            const input = document.getElementById(field === 'immat' ? 'immatriculation' : field === 'km' ? 'kilometrage' : field === 'tel' ? 'telephone' : field);
            const error = document.getElementById('error-' + field);
            input.classList.add('error');
            error.classList.add('visible');
        }

        function hideError(field) {
            const input = document.getElementById(field === 'immat' ? 'immatriculation' : field === 'km' ? 'kilometrage' : field === 'tel' ? 'telephone' : field);
            const error = document.getElementById('error-' + field);
            input.classList.remove('error');
            error.classList.remove('visible');
        }

        function goToStep(step) {
            if (!validateCurrentStep()) return;

            if (currentStep === 1 && step === 2) {
                showLoader();
                setTimeout(() => {
                    hideLoader();
                    changeStep(step);
                }, 1500);
            } else {
                changeStep(step);
            }
        }

        function changeStep(step) {
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            currentStep = step;
            document.getElementById(`step-${currentStep}`).classList.add('active');

            const progress = (step / 4) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('step-text').textContent = `Étape ${step}/4`;

            const subtitle = document.getElementById('subtitle');
            const mainTitle = document.querySelector('.main-title');
            const backButton = document.querySelector('.back-button');
            const progressContainer = document.getElementById('progress-container');
            
            if (step >= 2) {
                subtitle?.classList.add('hidden');
                backButton?.classList.add('visible');
            } else {
                subtitle?.classList.remove('hidden');
                backButton?.classList.remove('visible');
            }

            if (step === 4) {
                mainTitle?.classList.add('hidden');
                subtitle?.classList.add('hidden');
                if (progressContainer) progressContainer.style.display = 'none';
                calculateEstimation();
            } else {
                mainTitle?.classList.remove('hidden');
                if (progressContainer) progressContainer.style.display = 'block';
            }

            updateRecap(step);
            document.querySelector('.widget-content').scrollTop = 0;
        }

        function showLoader() {
            document.getElementById('loader').classList.add('active');
        }

        function hideLoader() {
            document.getElementById('loader').classList.remove('active');
        }

        function goBack() {
            if (currentStep > 1) {
                const prevStep = currentStep - 1;
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                currentStep = prevStep;
                document.getElementById(`step-${currentStep}`).classList.add('active');

                const progress = (currentStep / 4) * 100;
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('step-text').textContent = `Étape ${currentStep}/4`;

                const subtitle = document.getElementById('subtitle');
                const backButton = document.querySelector('.back-button');
                const progressContainer = document.getElementById('progress-container');

                if (currentStep === 1) {
                    subtitle?.classList.remove('hidden');
                    backButton?.classList.remove('visible');
                }

                if (progressContainer) progressContainer.style.display = 'block';
                document.querySelector('.widget-content').scrollTop = 0;
            } else if (currentStep === '1b') {
                // Retour de 1b vers 1
                document.getElementById('step-1b').classList.remove('active');
                document.getElementById('step-1').classList.add('active');
                currentStep = 1;
                
                const subtitle = document.getElementById('subtitle');
                const backButton = document.querySelector('.back-button');
                
                subtitle?.classList.remove('hidden');
                backButton?.classList.remove('visible');
                
                document.querySelector('.widget-content').scrollTop = 0;
            }
        }

        function validateCurrentStep() {
            if (currentStep === 1) {
                const immat = document.getElementById('immatriculation').value.trim();
                const km = document.getElementById('kilometrage').value.trim();
                
                let isValid = true;
                
                const immatRegex = /^[A-Z]{2}-[0-9]{3}-[A-Z]{2}$/;
                if (!immat || !immatRegex.test(immat)) {
                    showError('immat');
                    isValid = false;
                }
                
                if (!km || parseInt(km) <= 0) {
                    showError('km');
                    isValid = false;
                }
                
                if (!isValid) return false;
                
                userData.immatriculation = immat;
                userData.kilometrage = km;
            }

            if (currentStep === '1b') {
                // Validation saisie manuelle
                userData.marque = document.getElementById('marque').value.trim();
                userData.modele = document.getElementById('modele').value.trim();
                userData.mois = document.getElementById('mois').value.trim();
                userData.annee = document.getElementById('annee').value.trim();
                userData.energie = document.getElementById('energie').value.trim();
                userData.version = document.getElementById('version').value.trim();
                userData.kilometrage = document.getElementById('kilometrage-manual').value.trim();
                
                return true;
            }

            if (currentStep === 2) {
                if (!selectedFinition) {
                    alert('Veuillez sélectionner une finition');
                    return false;
                }
                userData.finition = selectedFinition;
            }

            if (currentStep === 3) {
                const nom = document.getElementById('nom').value.trim();
                const prenom = document.getElementById('prenom').value.trim();
                const email = document.getElementById('email').value.trim();
                const tel = document.getElementById('telephone').value.trim();
                const consent1 = document.getElementById('consent1').checked;

                let isValid = true;
                
                const nameRegex = /^[a-zA-ZÀ-ÿ\s\-']+$/;
                if (!nom || !nameRegex.test(nom)) {
                    showError('nom');
                    isValid = false;
                }
                
                if (!prenom || !nameRegex.test(prenom)) {
                    showError('prenom');
                    isValid = false;
                }
                
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!email || !emailRegex.test(email)) {
                    showError('email');
                    isValid = false;
                }
                
                const telRegex = /^[0-9]{2}\s[0-9]{2}\s[0-9]{2}\s[0-9]{2}\s[0-9]{2}$/;
                if (!tel || !telRegex.test(tel)) {
                    showError('tel');
                    isValid = false;
                }
                
                if (!consent1) {
                    alert('Veuillez accepter les conditions de confidentialité');
                    isValid = false;
                }
                
                if (!isValid) return false;
            }

            return true;
        }

        function selectFinition(finition) {
            document.querySelectorAll('.finition-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.classList.add('selected');
            selectedFinition = finition;
            document.getElementById('btn-step2').disabled = false;
        }

        function updateRecap(step) {
            if (step >= 2) {
                let recap = '';
                if (userData.immatriculation) {
                    // Parcours avec immatriculation
                    recap = `Peugeot 308 Hybride • 2022 • ${parseInt(userData.kilometrage).toLocaleString('fr-FR')} km${userData.finition ? ' • ' + userData.finition : ''}`;
                } else {
                    // Parcours manuel
                    const moisNames = ['', 'Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
                    const moisName = userData.mois ? moisNames[parseInt(userData.mois)] : '';
                    recap = `${userData.marque} ${userData.modele} • ${userData.energie} • ${moisName} ${userData.annee} • ${parseInt(userData.kilometrage).toLocaleString('fr-FR')} km`;
                }
                const element = document.getElementById(`recap-step${step}`);
                if (element) element.innerHTML = recap;
            }
        }

        function calculateEstimation() {
            const basePrice = 15000;
            const kmPenalty = Math.floor(userData.kilometrage / 10000) * 500;
            const estimatedPrice = Math.max(8000, basePrice - kmPenalty);
            document.getElementById('estimated-price').textContent = estimatedPrice.toLocaleString('fr-FR') + ' €';
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const title = event.target;
            if (section) {
                section.classList.toggle('hidden');
                title.classList.toggle('collapsed');
            }
        }

        function closeWidget() {
            if (confirm('Voulez-vous vraiment fermer l\'estimation ?')) {
                window.location.reload();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeWidget();
        });
    </script>
</body>
</html>
