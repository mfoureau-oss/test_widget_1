<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Estimation SPOTICAR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: rgba(0, 0, 0, 0.5);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow: hidden;
        }

        html {
            height: -webkit-fill-available;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .widget-container {
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            max-height: calc(100vh - 2rem);
            background: #ffffff;
            border-radius: 16px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @supports (-webkit-touch-callout: none) {
            .widget-container {
                max-height: calc(100vh - 180px);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 36px;
            height: 36px;
            border: none;
            background: #f1f5f9;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #64748b;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .back-button {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            width: 36px;
            height: 36px;
            border: none;
            background: #f1f5f9;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: #64748b;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .back-button.visible {
            display: flex;
        }

        .close-btn:hover, .back-button:hover {
            background: #e2e8f0;
            color: #475569;
        }

        .widget-header {
            padding: 1rem 1.5rem 0.5rem;
            text-align: center;
        }

        .logo {
            width: 160px;
            height: 50px;
            margin: 0 auto 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo img {
            width: 100%;
            height: auto;
            object-fit: contain;
        }

        .main-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #000;
            margin-bottom: 0.3rem;
        }

        .main-title.hidden {
            display: none !important;
        }

        .subtitle {
            font-size: 0.95rem;
            color: #666;
        }

        .subtitle.hidden {
            display: none !important;
        }

        .progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #13d0ca;
            transition: width 0.3s ease;
        }

        .step-indicator {
            text-align: center;
            font-size: 0.85rem;
            color: #666;
            white-space: nowrap;
            font-weight: 500;
        }

        .widget-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 1.5rem 1.5rem;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            color: #000;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            color: #000;
            font-family: Arial, sans-serif;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #13d0ca;
        }

        .form-input::placeholder {
            color: #999;
        }

        .vehicle-recap {
            background: transparent;
            padding: 0;
            border-radius: 0;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: #666;
            text-align: center;
        }

        .finition-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.625rem;
            margin-bottom: 1rem;
        }

        .finition-card {
            padding: 0.875rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-size: 0.9rem;
            color: #000;
            font-weight: 500;
        }

        .finition-card:hover {
            border-color: #13d0ca;
            background: #f0fffe;
        }

        .finition-card.selected {
            border-color: #13d0ca;
            background: #13d0ca;
            color: white;
        }

        .checkbox-group {
            margin-bottom: 1rem;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin-top: 0.25rem;
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            cursor: pointer;
            accent-color: #13d0ca;
        }

        .checkbox-wrapper label {
            font-size: 0.8rem;
            color: #333;
            line-height: 1.5;
            cursor: pointer;
        }

        .checkbox-wrapper label a {
            color: #13d0ca;
            text-decoration: underline;
        }

        .consent-section-title {
            font-weight: bold;
            font-size: 0.875rem;
            color: #000;
            margin: 1.5rem 0 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .consent-section-title::after {
            content: '▲';
            font-size: 0.7rem;
            color: #13d0ca;
        }

        .consent-section-title.collapsed::after {
            content: '▼';
        }

        .consent-details {
            font-size: 0.8rem;
            color: #555;
            line-height: 1.6;
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        .consent-details.hidden {
            display: none;
        }

        .result-price {
            text-align: center;
            margin: 0.5rem 0 1rem;
        }

        .price-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .price-amount {
            font-size: 2.25rem;
            font-weight: bold;
            color: #13d0ca;
        }

        .info-box {
            background: #f8f8f8;
            padding: 0.875rem;
            border-radius: 8px;
            margin: 1rem 0 0.875rem;
            font-size: 0.75rem;
            line-height: 1.5;
            color: #333;
        }

        .info-box strong {
            color: #000;
            display: block;
            margin-bottom: 0.375rem;
            font-size: 0.8rem;
        }

        .next-steps {
            margin-top: 0.875rem;
        }

        .next-steps-title {
            font-size: 0.95rem;
            font-weight: bold;
            color: #000;
            margin-bottom: 0.625rem;
            text-align: center;
        }

        .steps-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.625rem;
        }

        .step-card {
            background: #f8f8f8;
            padding: 0.875rem;
            border-radius: 8px;
            border-left: 4px solid #13d0ca;
        }

        .step-card-title {
            font-weight: bold;
            color: #000;
            margin-bottom: 0.375rem;
            font-size: 0.8rem;
        }

        .step-card-text {
            font-size: 0.75rem;
            color: #555;
            line-height: 1.4;
        }

        .cta-button {
            width: 100%;
            padding: 0.875rem;
            background: #13d0ca;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: Arial, sans-serif;
            margin-top: 1rem;
        }

        .cta-button:hover {
            background: #0fb8b3;
            transform: translateY(-1px);
        }

        .cta-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        @media (min-width: 640px) {
            .finition-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .steps-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr !important;
            }
            .form-row .form-group {
                margin-bottom: 1rem !important;
            }
        }

        @media (max-height: 700px) {
            .widget-container {
                max-height: 95vh;
            }
            .main-title {
                font-size: 1.25rem;
            }
            .logo {
                width: 120px;
                height: 35px;
            }
        }
    </style>
</head>
<body>
    <div class="modal-overlay">
        <div class="widget-container">
            <button class="back-button" onclick="goBack()" aria-label="Retour">←</button>
            <button class="close-btn" onclick="closeWidget()" aria-label="Fermer">×</button>
            
            <div class="widget-header">
                <div class="logo">
                    <img src="https://www.spoticar.lu/sites/spoticar.be/files/inline-images/2019-01-07-Logo-Spoticar.png" alt="SPOTICAR">
                </div>
                <h1 class="main-title">Informations sur votre véhicule</h1>
                <p class="subtitle" id="subtitle">Nous vous fournissons une estimation de votre voiture, basée sur son immatriculation, sa version et son kilométrage.</p>
            </div>

            <div id="progress-container">
                <div style="display: flex; align-items: center; gap: 1rem; margin: 0.5rem 1.5rem 0.75rem;">
                    <div class="progress-bar" style="margin: 0; flex: 1;">
                        <div class="progress-fill" id="progress-fill" style="width: 25%"></div>
                    </div>
                    <div class="step-indicator" style="margin: 0;">
                        <span id="step-text">Étape 1/4</span>
                    </div>
                </div>
            </div>

            <div class="widget-content">
                <!-- ÉTAPE 1 -->
                <div class="step active" id="step-1">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;" class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Immatriculation</label>
                            <input type="text" class="form-input" id="immatriculation" placeholder="AB-123-CD" maxlength="9">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Kilométrage</label>
                            <input type="number" class="form-input" id="kilometrage" placeholder="Ex: 75000" min="0">
                        </div>
                    </div>
                    
                    <div style="background: #f0fffe; border-left: 3px solid #13d0ca; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.25rem;">✓</span>
                            <strong style="font-size: 0.9rem; color: #000;">Estimation gratuite et instantanée</strong>
                        </div>
                        <p style="font-size: 0.8rem; color: #555; line-height: 1.5; margin: 0;">
                            Obtenez une estimation précise de votre véhicule en quelques clics, sans engagement et en toute confidentialité.
                        </p>
                    </div>
                    
                    <button class="cta-button" onclick="goToStep(2)">Suivant</button>
                </div>

                <!-- ÉTAPE 2 -->
                <div class="step" id="step-2">
                    <div class="vehicle-recap" id="recap-step2" style="margin-bottom: 1rem;"></div>
                    
                    <h2 class="form-label" style="margin-bottom: 0.875rem; font-size: 0.95rem;">Sélectionnez la finition</h2>
                    <div class="finition-grid" style="margin-bottom: 1rem;">
                        <div class="finition-card" onclick="selectFinition('Active')">Active</div>
                        <div class="finition-card" onclick="selectFinition('Allure')">Allure</div>
                        <div class="finition-card" onclick="selectFinition('GT Line')">GT Line</div>
                        <div class="finition-card" onclick="selectFinition('GT')">GT</div>
                        <div class="finition-card" onclick="selectFinition('Style')">Style</div>
                        <div class="finition-card" onclick="selectFinition('Access')">Access</div>
                    </div>
                    <button class="cta-button" onclick="goToStep(3)" id="btn-step2" disabled style="margin-top: 0.75rem;">Suivant</button>
                </div>

                <!-- ÉTAPE 3 -->
                <div class="step" id="step-3">
                    <div class="vehicle-recap" id="recap-step3"></div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;" class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Nom</label>
                            <input type="text" class="form-input" id="nom" placeholder="Votre nom">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Prénom</label>
                            <input type="text" class="form-input" id="prenom" placeholder="Votre prénom">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;" class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="email" placeholder="votre@email.com">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Téléphone</label>
                            <input type="tel" class="form-input" id="telephone" placeholder="06 12 34 56 78">
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <h3 style="font-size: 0.9rem; font-weight: bold; color: #000; margin-bottom: 1rem;">Consentements</h3>
                        
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="consent1" required>
                            <label for="consent1">Vos données personnelles seront traitées par SVO - SPOTICAR, situé au 2-10 Boulevard de l'Europe, 78300 Poissy, en tant que responsable de traitement, tel que décrit dans la <a href="#" target="_blank">Politique de Confidentialité</a>, où vous trouverez plus d'informations sur vos droits liés à la confidentialité et les moyens de nous contacter.</label>
                        </div>

                        <div class="consent-section-title" onclick="toggleSection('rejoignez1')">
                            Rejoignez-nous !
                        </div>
                        <div class="consent-details" id="rejoignez1">
                            Nous aimerions entretenir un lien privilégié avec vous et vous seul(e), et personnaliser l'expérience que nous allons partager ! Recevez des offres et des affaires personnalisées, des promotions, des invitations à des événements et d'autres contenus intéressants sur nos marques. Restons en contact ! Si vous voulez en savoir plus sur ce que nous ferons de vos données, consultez les sections 4.c et 4.h de notre <a href="#" target="_blank">Politique de confidentialité</a>. Et ne vous inquiétez pas ! Vous pourrez changer d'avis à tout moment en cliquant sur https://preferences.stellantis.com ! Si vous souhaitez donner votre consentement à des fins explicites uniquement
                        </div>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="consent2">
                            <label for="consent2">Je suis d'accord</label>
                        </div>

                        <div class="consent-section-title" onclick="toggleSection('partenaires')">
                            Rejoignez nos partenaires !
                        </div>
                        <div class="consent-details" id="partenaires">
                            Nous formons une grande communauté et partageons des choses intéressantes ! Si vous souhaitez rencontrer nos fantastiques partenaires et leur permettre de vous contacter directement, inscrivez-vous ! Si vous voulez en savoir plus sur ce que nous ferons de vos données, consultez la section 4.h de notre <a href="#" target="_blank">Politique de confidentialité</a>. Et ne vous inquiétez pas ! Vous pourrez changer d'avis à tout moment en cliquant sur https://preferences.stellantis.com !
                        </div>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="consent3">
                            <label for="consent3">Je suis d'accord</label>
                        </div>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="consent4">
                            <label for="consent4">Je ne suis pas d'accord</label>
                        </div>
                    </div>
                    
                    <button class="cta-button" onclick="goToStep(4)">Valider</button>
                </div>

                <!-- ÉTAPE 4 -->
                <div class="step" id="step-4">
                    <div class="result-price">
                        <div class="price-label">Estimation de votre véhicule</div>
                        <div class="price-amount" id="estimated-price">12 500 €</div>
                    </div>

                    <div class="vehicle-recap" id="recap-step4" style="font-size: 0.8rem; margin-bottom: 1rem;"></div>

                    <div class="info-box">
                        <strong>Comment avons-nous calculé ce prix ?</strong>
                        Notre estimation repose sur les caractéristiques de votre véhicule et sur l'analyse des tendances du marché. Elle inclut une déduction forfaitaire pour les frais de remise en état, ajustable en fonction de l'état réel de votre voiture.
                    </div>

                    <div class="next-steps">
                        <h3 class="next-steps-title">Prochaines étapes</h3>
                        <div class="steps-grid">
                            <div class="step-card">
                                <div class="step-card-title">Vente simplifiée</div>
                                <div class="step-card-text">Aucune démarche administrative à votre charge</div>
                            </div>
                            <div class="step-card">
                                <div class="step-card-title">Prise en main</div>
                                <div class="step-card-text">Une prise en main par un professionnel qualifié</div>
                            </div>
                        </div>
                    </div>

                    <button class="cta-button" onclick="closeWidget()">Terminer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedFinition = null;
        let userData = {
            immatriculation: '',
            kilometrage: '',
            finition: '',
            nom: '',
            prenom: '',
            email: '',
            telephone: ''
        };

        function goToStep(step) {
            if (!validateCurrentStep()) {
                return;
            }

            document.getElementById(`step-${currentStep}`).classList.remove('active');
            currentStep = step;
            document.getElementById(`step-${currentStep}`).classList.add('active');

            const progress = (step / 4) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('step-text').textContent = `Étape ${step}/4`;

            const subtitle = document.getElementById('subtitle');
            const mainTitle = document.querySelector('.main-title');
            const backButton = document.querySelector('.back-button');
            const progressContainer = document.getElementById('progress-container');
            
            if (subtitle) {
                if (step >= 2) {
                    subtitle.classList.add('hidden');
                } else {
                    subtitle.classList.remove('hidden');
                }
            }

            if (mainTitle) {
                if (step === 4) {
                    mainTitle.classList.add('hidden');
                    if (subtitle) subtitle.classList.add('hidden');
                } else {
                    mainTitle.classList.remove('hidden');
                }
            }

            if (backButton) {
                if (step >= 2) {
                    backButton.classList.add('visible');
                } else {
                    backButton.classList.remove('visible');
                }
            }

            if (step === 4 && progressContainer) {
                progressContainer.style.display = 'none';
                calculateEstimation();
            }

            updateRecap(step);
        }

        function goBack() {
            if (currentStep > 1) {
                const prevStep = currentStep - 1;
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                currentStep = prevStep;
                document.getElementById(`step-${currentStep}`).classList.add('active');

                const progress = (currentStep / 4) * 100;
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('step-text').textContent = `Étape ${currentStep}/4`;

                const subtitle = document.getElementById('subtitle');
                const mainTitle = document.querySelector('main-title');
                const backButton = document.querySelector('.back-button');
                const progressContainer = document.getElementById('progress-container');

                if (currentStep === 1) {
                    if (subtitle) subtitle.classList.remove('hidden');
                    if (backButton) backButton.classList.remove('visible');
                }

                if (currentStep < 4 && progressContainer) {
                    progressContainer.style.display = 'block';
                }
            }
        }

        function validateCurrentStep() {
            if (currentStep === 1) {
                const immat = document.getElementById('immatriculation').value.trim();
                const km = document.getElementById('kilometrage').value.trim();
                
                if (!immat || !km) {
                    alert('Veuillez remplir tous les champs');
                    return false;
                }
                
                userData.immatriculation = immat;
                userData.kilometrage = km;
            }

            if (currentStep === 2) {
                if (!selectedFinition) {
                    alert('Veuillez sélectionner une finition');
                    return false;
                }
                userData.finition = selectedFinition;
            }

            if (currentStep === 3) {
                const nom = document.getElementById('nom').value.trim();
                const prenom = document.getElementById('prenom').value.trim();
                const email = document.getElementById('email').value.trim();
                const tel = document.getElementById('telephone').value.trim();
                const consent1 = document.getElementById('consent1').checked;

                if (!nom || !prenom || !email || !tel || !consent1) {
                    alert('Veuillez remplir tous les champs obligatoires et accepter les conditions de confidentialité');
                    return false;
                }

                userData.nom = nom;
                userData.prenom = prenom;
                userData.email = email;
                userData.telephone = tel;
            }

            return true;
        }

        function selectFinition(finition) {
            document.querySelectorAll('.finition-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.classList.add('selected');
            selectedFinition = finition;
            document.getElementById('btn-step2').disabled = false;
        }

        function updateRecap(step) {
            let recap = '';
            
            if (step === 2) {
                recap = `Peugeot 308 Hybride • 2022 • ${parseInt(userData.kilometrage).toLocaleString('fr-FR')} km`;
                document.getElementById('recap-step2').innerHTML = recap;
            } else if (step === 3 || step === 4) {
                recap = `Peugeot 308 Hybride • 2022 • ${parseInt(userData.kilometrage).toLocaleString('fr-FR')} km${userData.finition ? ' • ' + userData.finition : ''}`;
                if (step === 3) {
                    document.getElementById('recap-step3').innerHTML = recap;
                } else {
                    document.getElementById('recap-step4').innerHTML = recap;
                }
            }
        }

        function calculateEstimation() {
            const basePrice = 15000;
            const kmPenalty = Math.floor(userData.kilometrage / 10000) * 500;
            const estimatedPrice = Math.max(8000, basePrice - kmPenalty);
            
            document.getElementById('estimated-price').textContent = 
                estimatedPrice.toLocaleString('fr-FR') + ' €';
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const title = event.target;
            
            if (section) {
                section.classList.toggle('hidden');
                title.classList.toggle('collapsed');
            }
        }

        function closeWidget() {
            if (confirm('Voulez-vous vraiment fermer l\'estimation ?')) {
                window.location.reload();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeWidget();
            }
        });
    </script>
</body>
</html>
